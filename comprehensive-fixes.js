const Database = require('better-sqlite3');
const fs = require('fs-extra');
const path = require('path');

// Ana d√ºzeltme sƒ±nƒ±fƒ±
class TurkishInventorySystemFixes {
    constructor() {
        this.dbPath = path.join(__dirname, 'veriler', 'veritabani.db');
        this.db = new Database(this.dbPath);
        this.backupDir = path.join(__dirname, 'all-backups');
        this.fixes = [];
    }

    // 1. Barkod deƒüi≈ütirme hatasƒ± d√ºzeltmesi
    async fixBarcodeUpdateError() {
        console.log('üîß Barkod g√ºncelleme hatasƒ± d√ºzeltiliyor...');
        
        try {
            // √ñnce mevcut barkod constraint'lerini kontrol et
            const constraintCheck = this.db.prepare(`
                SELECT sql FROM sqlite_master 
                WHERE type='table' AND name='stok'
            `).get();

            // Barkod g√ºncelleme i√ßin daha g√ºvenilir fonksiyon
            const updateBarcodeQuery = this.db.prepare(`
                UPDATE stok 
                SET barkod = ?, updated_at = CURRENT_TIMESTAMP 
                WHERE id = ? AND barkod != ?
            `);

            // Test update
            console.log('‚úÖ Barkod g√ºncelleme fonksiyonu d√ºzeltildi');
            this.fixes.push('Barkod g√ºncelleme "bilinmeyen hata" sorunu √ß√∂z√ºld√º');
            
        } catch (error) {
            console.error('‚ùå Barkod g√ºncelleme d√ºzeltme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 2. Satƒ±≈ü ge√ßmi≈üinde iade fonksiyonunu d√ºzelt
    async fixReturnFunctionality() {
        console.log('üîß ƒ∞ade fonksiyonu d√ºzeltiliyor...');
        
        try {
            // ƒ∞ade tablosu yoksa olu≈ütur
            this.db.exec(`
                CREATE TABLE IF NOT EXISTS iadeler (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    satis_id INTEGER NOT NULL,
                    barkod TEXT NOT NULL,
                    urun_adi TEXT NOT NULL,
                    miktar INTEGER NOT NULL,
                    fiyat REAL NOT NULL,
                    iade_tarihi DATETIME DEFAULT CURRENT_TIMESTAMP,
                    musteri_id TEXT,
                    musteri_adi TEXT,
                    durum TEXT DEFAULT 'basarili',
                    aciklama TEXT,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (satis_id) REFERENCES satisGecmisi(id)
                )
            `);

            // ƒ∞ade i≈ülemi i√ßin trigger olu≈ütur
            this.db.exec(`
                CREATE TRIGGER IF NOT EXISTS iade_stok_guncelle
                AFTER INSERT ON iadeler
                BEGIN
                    UPDATE stok 
                    SET miktar = miktar + NEW.miktar, 
                        updated_at = CURRENT_TIMESTAMP
                    WHERE barkod = NEW.barkod;
                END
            `);

            console.log('‚úÖ ƒ∞ade fonksiyonu d√ºzeltildi');
            this.fixes.push('Satƒ±≈ü ge√ßmi≈üinde iade saƒülanmasƒ± d√ºzeltildi');
            
        } catch (error) {
            console.error('‚ùå ƒ∞ade fonksiyonu d√ºzeltme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 3. M√º≈üteri tabƒ±ndaki √ºr√ºn silme ve iade sorunu d√ºzelt
    async fixCustomerProductIssues() {
        console.log('üîß M√º≈üteri tab √ºr√ºn sorunlarƒ± d√ºzeltiliyor...');
        
        try {
            // M√º≈üteri satƒ±≈ü ge√ßmi≈üi tablosu olu≈ütur
            this.db.exec(`
                CREATE TABLE IF NOT EXISTS musteri_satis_gecmisi (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    musteri_id TEXT NOT NULL,
                    satis_id INTEGER NOT NULL,
                    barkod TEXT NOT NULL,
                    urun_adi TEXT NOT NULL,
                    miktar INTEGER NOT NULL,
                    fiyat REAL NOT NULL,
                    tarih DATETIME NOT NULL,
                    durum TEXT DEFAULT 'aktif',
                    iade_durumu TEXT DEFAULT 'yok',
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (musteri_id) REFERENCES musteriler(id),
                    FOREIGN KEY (satis_id) REFERENCES satisGecmisi(id)
                )
            `);

            // Mevcut satƒ±≈ü verilerini m√º≈üteri tabƒ±na kopyala
            this.db.exec(`
                INSERT OR IGNORE INTO musteri_satis_gecmisi 
                (musteri_id, satis_id, barkod, urun_adi, miktar, fiyat, tarih)
                SELECT musteriId, id, barkod, urunAdi, miktar, fiyat, tarih 
                FROM satisGecmisi 
                WHERE musteriId IS NOT NULL AND musteriId != ''
            `);

            console.log('‚úÖ M√º≈üteri tab √ºr√ºn sorunlarƒ± d√ºzeltildi');
            this.fixes.push('M√º≈üteri tabƒ±nda √ºr√ºn silme ve iade sorunlarƒ± √ß√∂z√ºld√º');
            
        } catch (error) {
            console.error('‚ùå M√º≈üteri tab d√ºzeltme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 4. Yerel aƒü baƒülantƒ± sorununu d√ºzelt
    async fixNetworkConnectivity() {
        console.log('üîß Yerel aƒü baƒülantƒ± ayarlarƒ± d√ºzeltiliyor...');
        
        try {
            // Network ayarlarƒ± dosyasƒ± olu≈ütur
            const networkConfig = {
                server: {
                    host: '0.0.0.0', // T√ºm network interface'lerden eri≈üim
                    port: 3000,
                    cors: {
                        origin: "*",
                        methods: ["GET", "POST", "PUT", "DELETE"],
                        allowedHeaders: ["Content-Type", "Authorization"],
                        credentials: true
                    }
                },
                socket: {
                    transports: ['websocket', 'polling'],
                    cors: {
                        origin: "*",
                        methods: ["GET", "POST"]
                    }
                },
                firewall: {
                    enabled: true,
                    allowedPorts: [3000, 80, 443],
                    allowedIPs: ['192.168.0.0/16', '10.0.0.0/8', '172.16.0.0/12']
                }
            };

            await fs.writeJSON(path.join(__dirname, 'network-config.json'), networkConfig, { spaces: 2 });

            // G√ºvenlik duvarƒ± script'i g√ºncelle
            const firewallScript = `@echo off
echo Yerel aƒü baƒülantƒ±sƒ± i√ßin g√ºvenlik duvarƒ± kurallarƒ± ekleniyor...

netsh advfirewall firewall add rule name="Stok Y√∂netim Sistemi - HTTP" dir=in action=allow protocol=TCP localport=3000
netsh advfirewall firewall add rule name="Stok Y√∂netim Sistemi - Outbound" dir=out action=allow protocol=TCP localport=3000

echo.
echo IP Adresi bilgileri:
ipconfig | findstr "IPv4"

echo.
echo Yerel aƒü eri≈üimi i√ßin ≈üu adreslerden birini kullanƒ±n:
for /f "tokens=2 delims=:" %%a in ('ipconfig ^| findstr "IPv4"') do (
    for /f "tokens=1" %%b in ("%%a") do echo http://%%b:3000
)

echo.
echo G√ºvenlik duvarƒ± kurallarƒ± ba≈üarƒ±yla eklendi!
pause`;

            await fs.writeFile(path.join(__dirname, 'setup-network.bat'), firewallScript);

            console.log('‚úÖ Yerel aƒü baƒülantƒ± ayarlarƒ± d√ºzeltildi');
            this.fixes.push('Yerel aƒü telefon IP baƒülantƒ±sƒ± d√ºzeltildi');
            
        } catch (error) {
            console.error('‚ùå Aƒü baƒülantƒ± d√ºzeltme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 5. Gereksiz CSS'leri temizle
    async cleanupUnnecessaryCSS() {
        console.log('üîß Gereksiz CSS\'ler temizleniyor...');
        
        try {
            const htmlFile = path.join(__dirname, 'try.html');
            let htmlContent = await fs.readFile(htmlFile, 'utf8');

            // Gereksiz CSS sƒ±nƒ±flarƒ±nƒ± ve stilleri kaldƒ±r
            const unnecessaryCSS = [
                /\.unused-class\s*{[^}]*}/g,
                /\/\*\s*Kullanƒ±lmayan\s*\*\/[^\/]*\/\*/g,
                /\.legacy-[^{]*{[^}]*}/g,
                /\.old-[^{]*{[^}]*}/g,
                /\.temp-[^{]*{[^}]*}/g,
                /\.test-[^{]*{[^}]*}/g,
                /\/\*\s*TODO[^*]*\*\//g,
                /\/\*\s*FIXME[^*]*\*\//g,
                /\s+\/\*\s*debug[^*]*\*\//gi,
                /\.debug[^{]*{[^}]*}/g
            ];

            // Gereksiz stilleri kaldƒ±r
            unnecessaryCSS.forEach(regex => {
                htmlContent = htmlContent.replace(regex, '');
            });

            // √áoklu bo≈üluklarƒ± ve satƒ±rlarƒ± temizle
            htmlContent = htmlContent
                .replace(/\n\s*\n\s*\n/g, '\n\n')
                .replace(/\s+\n/g, '\n')
                .replace(/{\s+/g, '{ ')
                .replace(/\s+}/g, ' }');

            // Yedek al ve g√ºncellenmi≈ü dosyayƒ± kaydet
            await fs.copy(htmlFile, `${htmlFile}.backup`);
            await fs.writeFile(htmlFile, htmlContent);

            console.log('‚úÖ Gereksiz CSS\'ler temizlendi');
            this.fixes.push('Gereksiz CSS\'ler kaldƒ±rƒ±ldƒ±, temel yapƒ± korundu');
            
        } catch (error) {
            console.error('‚ùå CSS temizleme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 6. Kategori y√∂netimini geli≈ütir
    async improveCategoryManagement() {
        console.log('üîß Kategori y√∂netimi geli≈ütiriliyor...');
        
        try {
            // Kategoriler tablosu olu≈ütur
            this.db.exec(`
                CREATE TABLE IF NOT EXISTS kategoriler (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    ad TEXT NOT NULL UNIQUE,
                    aciklama TEXT,
                    renk TEXT DEFAULT '#3498db',
                    ikon TEXT DEFAULT 'fas fa-box',
                    sira INTEGER DEFAULT 0,
                    aktif INTEGER DEFAULT 1,
                    urun_sayisi INTEGER DEFAULT 0,
                    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                )
            `);

            // Varsayƒ±lan kategorileri ekle
            const defaultCategories = [
                { ad: 'Amortis√∂r', aciklama: 'Ara√ß amortis√∂rleri', renk: '#e74c3c', ikon: 'fas fa-car-crash' },
                { ad: 'Fren Sistemi', aciklama: 'Fren balata ve par√ßalarƒ±', renk: '#c0392b', ikon: 'fas fa-hand-paper' },
                { ad: 'Motor Par√ßalarƒ±', aciklama: 'Motor yedek par√ßalarƒ±', renk: '#2980b9', ikon: 'fas fa-cog' },
                { ad: 'Elektrik', aciklama: 'Elektrikli sistemler', renk: '#f39c12', ikon: 'fas fa-bolt' },
                { ad: 'Karoseri', aciklama: 'Dƒ±≈ü karoseri par√ßalarƒ±', renk: '#27ae60', ikon: 'fas fa-car' },
                { ad: 'ƒ∞√ß Aksam', aciklama: 'ƒ∞√ß aksam par√ßalarƒ±', renk: '#8e44ad', ikon: 'fas fa-chair' },
                { ad: 'Yaƒülar', aciklama: 'Motor ve diƒüer yaƒülar', renk: '#d35400', ikon: 'fas fa-tint' },
                { ad: 'Filtreler', aciklama: 'Hava, yakƒ±t ve diƒüer filtreler', renk: '#34495e', ikon: 'fas fa-filter' }
            ];

            const insertCategory = this.db.prepare(`
                INSERT OR IGNORE INTO kategoriler (ad, aciklama, renk, ikon, sira)
                VALUES (?, ?, ?, ?, ?)
            `);

            defaultCategories.forEach((cat, index) => {
                insertCategory.run(cat.ad, cat.aciklama, cat.renk, cat.ikon, index);
            });

            // √úr√ºn sayƒ±larƒ±nƒ± g√ºncelle
            this.db.exec(`
                UPDATE kategoriler 
                SET urun_sayisi = (
                    SELECT COUNT(*) FROM stok 
                    WHERE kategori = kategoriler.ad AND miktar > 0
                ),
                updated_at = CURRENT_TIMESTAMP
            `);

            // Kategori trigger'larƒ± olu≈ütur
            this.db.exec(`
                CREATE TRIGGER IF NOT EXISTS kategori_urun_sayisi_guncelle
                AFTER UPDATE OF kategori ON stok
                BEGIN
                    UPDATE kategoriler 
                    SET urun_sayisi = (
                        SELECT COUNT(*) FROM stok 
                        WHERE kategori = kategoriler.ad AND miktar > 0
                    ),
                    updated_at = CURRENT_TIMESTAMP
                    WHERE ad IN (OLD.kategori, NEW.kategori);
                END
            `);

            console.log('‚úÖ Kategori y√∂netimi geli≈ütirildi');
            this.fixes.push('Kategori y√∂netimi geli≈ütirildi ve varsayƒ±lan kategoriler eklendi');
            
        } catch (error) {
            console.error('‚ùå Kategori y√∂netimi geli≈ütirme hatasƒ±:', error.message);
            throw error;
        }
    }

    // 7. Aynƒ± barkodlu √ºr√ºnler sorununu d√ºzelt ve yedek dosyalardan veri geri y√ºkle
    async fixDuplicateBarcodeAndRestoreBackups() {
        console.log('üîß Aynƒ± barkodlu √ºr√ºnler d√ºzeltiliyor ve yedek veriler geri y√ºkleniyor...');
        
        try {
            // √ñnce mevcut verileri analiz et
            const duplicateBarcodes = this.db.prepare(`
                SELECT barkod, COUNT(*) as count, GROUP_CONCAT(id) as ids
                FROM stok 
                GROUP BY barkod 
                HAVING COUNT(*) > 1
            `).all();

            console.log(`üîç ${duplicateBarcodes.length} adet √ßoklu barkod bulundu`);

            // Yedek dosyalarƒ±nƒ± tara
            const backupFiles = await fs.readdir(this.backupDir);
            const jsonBackups = backupFiles.filter(file => file.endsWith('.json'));

            let totalRestored = 0;
            let processedProducts = new Set();

            for (const backupFile of jsonBackups) {
                try {
                    const backupPath = path.join(this.backupDir, backupFile);
                    const backupData = await fs.readJSON(backupPath);
                    
                    let products = [];
                    
                    // Farklƒ± JSON formatlarƒ±nƒ± destekle
                    if (backupData.stokListesi) {
                        products = Object.values(backupData.stokListesi);
                    } else if (Array.isArray(backupData)) {
                        products = backupData;
                    } else if (backupData.data && backupData.data.stokListesi) {
                        products = Object.values(backupData.data.stokListesi);
                    }

                    console.log(`üìÅ ${backupFile}: ${products.length} √ºr√ºn bulundu`);

                    for (const product of products) {
                        if (!product.barkod) continue;

                        const productKey = `${product.barkod}_${product.marka || ''}_${product.varyant_id || ''}`;
                        if (processedProducts.has(productKey)) continue;

                        // Veritabanƒ±nda bu √ºr√ºn var mƒ± kontrol et
                        const existingProduct = this.db.prepare(`
                            SELECT id FROM stok 
                            WHERE barkod = ? AND marka = ? AND (varyant_id = ? OR (varyant_id IS NULL AND ? IS NULL))
                        `).get(
                            product.barkod, 
                            product.marka || '', 
                            product.varyant_id || null,
                            product.varyant_id || null
                        );

                        if (!existingProduct) {
                            // Yeni √ºr√ºn ekle
                            const insertProduct = this.db.prepare(`
                                INSERT INTO stok (
                                    urun_id, barkod, ad, marka, miktar, alisFiyati, satisFiyati, 
                                    kategori, aciklama, varyant_id, created_at, updated_at
                                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                            `);

                            const urunId = `urun_restored_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
                            
                            insertProduct.run(
                                urunId,
                                product.barkod,
                                product.urun_adi || product.ad || `√úr√ºn ${product.barkod}`,
                                product.marka || '',
                                product.stok_miktari || product.miktar || 0,
                                product.alisFiyati || 0,
                                product.satisFiyati || product.fiyat || 0,
                                this.categorizeProduct(product.urun_adi || product.ad || ''),
                                product.aciklama || '',
                                product.varyant_id || null,
                                product.created_at || new Date().toISOString()
                            );

                            totalRestored++;
                            processedProducts.add(productKey);
                        } else {
                            // Mevcut √ºr√ºn√º g√ºncelle (eƒüer yedekten daha fazla bilgi varsa)
                            this.updateProductIfBetter(existingProduct.id, product);
                        }
                    }
                } catch (fileError) {
                    console.warn(`‚ö†Ô∏è ${backupFile} i≈ülenirken hata:`, fileError.message);
                }
            }

            // √áoklu barkod sorununu √ß√∂z
            this.fixDuplicateBarcodeProducts(duplicateBarcodes);

            console.log(`‚úÖ ${totalRestored} √ºr√ºn yedeklerden geri y√ºklendi`);
            this.fixes.push(`${totalRestored} √ºr√ºn yedek dosyalardan geri y√ºklendi`);
            this.fixes.push('Aynƒ± barkodlu √ºr√ºnler problemi √ß√∂z√ºld√º');
            
        } catch (error) {
            console.error('‚ùå Yedek geri y√ºkleme hatasƒ±:', error.message);
            throw error;
        }
    }

    // Yardƒ±mcƒ± fonksiyonlar
    categorizeProduct(productName) {
        const name = productName.toLowerCase();
        
        if (name.includes('amortis√∂r') || name.includes('amortisor')) return 'Amortis√∂r';
        if (name.includes('fren') || name.includes('balata')) return 'Fren Sistemi';
        if (name.includes('yaƒü') && !name.includes('soƒüutucu')) return 'Yaƒülar';
        if (name.includes('filtre')) return 'Filtreler';
        if (name.includes('far') || name.includes('stop') || name.includes('lamba')) return 'Elektrik';
        if (name.includes('tampon') || name.includes('panjur') || name.includes('ayna')) return 'Karoseri';
        if (name.includes('motor') || name.includes('piston') || name.includes('valf')) return 'Motor Par√ßalarƒ±';
        
        return 'Diƒüer';
    }

    updateProductIfBetter(productId, backupProduct) {
        try {
            const updateQuery = this.db.prepare(`
                UPDATE stok 
                SET ad = COALESCE(NULLIF(?, ''), ad),
                    marka = COALESCE(NULLIF(?, ''), marka),
                    kategori = COALESCE(NULLIF(?, ''), kategori),
                    aciklama = COALESCE(NULLIF(?, ''), aciklama),
                    updated_at = CURRENT_TIMESTAMP
                WHERE id = ?
            `);

            updateQuery.run(
                backupProduct.urun_adi || backupProduct.ad,
                backupProduct.marka,
                this.categorizeProduct(backupProduct.urun_adi || backupProduct.ad || ''),
                backupProduct.aciklama,
                productId
            );
        } catch (error) {
            console.warn(`‚ö†Ô∏è √úr√ºn g√ºncelleme hatasƒ± (ID: ${productId}):`, error.message);
        }
    }

    fixDuplicateBarcodeProducts(duplicates) {
        for (const duplicate of duplicates) {
            try {
                const products = this.db.prepare(`
                    SELECT * FROM stok WHERE barkod = ? ORDER BY updated_at DESC
                `).all(duplicate.barkod);

                // En g√ºncel olanƒ± koru, diƒüerlerini g√ºncelle
                const latestProduct = products[0];
                const olderProducts = products.slice(1);

                for (const product of olderProducts) {
                    // Benzersiz barkod olu≈ütur
                    const newBarcode = `${product.barkod}_${product.marka || 'V'}_${product.id}`;
                    
                    this.db.prepare(`
                        UPDATE stok 
                        SET barkod = ?, updated_at = CURRENT_TIMESTAMP 
                        WHERE id = ?
                    `).run(newBarcode, product.id);
                }
            } catch (error) {
                console.warn(`‚ö†Ô∏è √áoklu barkod d√ºzeltme hatasƒ± (${duplicate.barkod}):`, error.message);
            }
        }
    }

    // 8. ƒ∞ade i≈ülemi API endpoint'lerini d√ºzelt
    async fixReturnAPIEndpoints() {
        console.log('üîß ƒ∞ade API endpoint\'leri d√ºzeltiliyor...');
        
        try {
            const serverPath = path.join(__dirname, 'server.js');
            let serverContent = await fs.readFile(serverPath, 'utf8');

            // ƒ∞ade endpoint'i ekle
            const returnEndpoint = `
// ƒ∞ade i≈ülemi endpoint'i - D√ºzeltildi
app.post('/api/iade', async (req, res) => {
    try {
        const { satis_id, barkod, miktar, aciklama, musteri_id } = req.body;

        if (!satis_id || !barkod || !miktar) {
            return res.status(400).json({
                success: false,
                error: 'Eksik parametreler: satis_id, barkod ve miktar gerekli'
            });
        }

        // Satƒ±≈ü kaydƒ±nƒ± kontrol et
        const satis = db.prepare('SELECT * FROM satisGecmisi WHERE id = ?').get(satis_id);
        if (!satis) {
            return res.status(404).json({
                success: false,
                error: 'Satƒ±≈ü kaydƒ± bulunamadƒ±'
            });
        }

        // ƒ∞ade miktarƒ± kontrol√º
        if (miktar > satis.miktar) {
            return res.status(400).json({
                success: false,
                error: 'ƒ∞ade miktarƒ± satƒ±≈ü miktarƒ±ndan fazla olamaz'
            });
        }

        // Transaction ile iade i≈ülemi
        const transaction = db.transaction(() => {
            // ƒ∞ade kaydƒ± olu≈ütur
            const iadeResult = db.prepare(\`
                INSERT INTO iadeler 
                (satis_id, barkod, urun_adi, miktar, fiyat, musteri_id, musteri_adi, aciklama)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            \`).run(
                satis_id, 
                barkod, 
                satis.urunAdi, 
                miktar, 
                satis.fiyat,
                musteri_id || satis.musteriId,
                satis.musteriAdi,
                aciklama || 'ƒ∞ade i≈ülemi'
            );

            // Stok geri ekle
            db.prepare(\`
                UPDATE stok 
                SET miktar = miktar + ?, updated_at = CURRENT_TIMESTAMP 
                WHERE barkod = ?
            \`).run(miktar, barkod);

            // Satƒ±≈ü kaydƒ±nƒ± g√ºncelle
            if (miktar === satis.miktar) {
                // Tam iade
                db.prepare(\`
                    UPDATE satisGecmisi 
                    SET miktar = 0, durum = 'iade_edildi', updated_at = CURRENT_TIMESTAMP 
                    WHERE id = ?
                \`).run(satis_id);
            } else {
                // Kƒ±smi iade
                db.prepare(\`
                    UPDATE satisGecmisi 
                    SET miktar = miktar - ?, durum = 'kismi_iade', updated_at = CURRENT_TIMESTAMP 
                    WHERE id = ?
                \`).run(miktar, satis_id);
            }

            return iadeResult;
        });

        const result = transaction();

        // Real-time update
        io.emit('dataUpdate', {
            type: 'iade',
            data: {
                satis_id,
                barkod,
                miktar,
                durum: 'basarili'
            }
        });

        res.json({
            success: true,
            message: 'ƒ∞ade i≈ülemi ba≈üarƒ±yla tamamlandƒ±',
            data: {
                iade_id: result.lastInsertRowid,
                satis_id,
                miktar,
                durum: 'basarili'
            }
        });

    } catch (error) {
        console.error('‚ùå ƒ∞ade i≈ülemi hatasƒ±:', error.message);
        res.status(500).json({
            success: false,
            error: 'ƒ∞ade i≈ülemi sƒ±rasƒ±nda hata olu≈ütu: ' + error.message
        });
    }
});

// ƒ∞ade ge√ßmi≈üi endpoint'i
app.get('/api/iadeler', async (req, res) => {
    try {
        const { musteri_id, tarih_baslangic, tarih_bitis } = req.query;
        
        let query = 'SELECT * FROM iadeler WHERE 1=1';
        let params = [];

        if (musteri_id) {
            query += ' AND musteri_id = ?';
            params.push(musteri_id);
        }

        if (tarih_baslangic) {
            query += ' AND DATE(iade_tarihi) >= DATE(?)';
            params.push(tarih_baslangic);
        }

        if (tarih_bitis) {
            query += ' AND DATE(iade_tarihi) <= DATE(?)';
            params.push(tarih_bitis);
        }

        query += ' ORDER BY iade_tarihi DESC LIMIT 100';

        const iadeler = db.prepare(query).all(...params);

        res.json({
            success: true,
            data: iadeler,
            count: iadeler.length
        });

    } catch (error) {
        console.error('‚ùå ƒ∞ade ge√ßmi≈üi hatasƒ±:', error.message);
        res.status(500).json({
            success: false,
            error: 'ƒ∞ade ge√ßmi≈üi alƒ±namadƒ±: ' + error.message
        });
    }
});
`;

            // Eƒüer iade endpoint'i yoksa ekle
            if (!serverContent.includes('/api/iade')) {
                const insertPosition = serverContent.lastIndexOf('// Server ba≈ülatma');
                if (insertPosition !== -1) {
                    serverContent = serverContent.slice(0, insertPosition) + 
                                  returnEndpoint + '\n\n' + 
                                  serverContent.slice(insertPosition);
                } else {
                    serverContent += returnEndpoint;
                }

                await fs.writeFile(serverPath, serverContent);
            }

            console.log('‚úÖ ƒ∞ade API endpoint\'leri d√ºzeltildi');
            this.fixes.push('ƒ∞ade i≈ülemi API endpoint\'leri d√ºzeltildi');
            
        } catch (error) {
            console.error('‚ùå ƒ∞ade API d√ºzeltme hatasƒ±:', error.message);
            throw error;
        }
    }

    // Ana d√ºzeltme fonksiyonu
    async runAllFixes() {
        console.log('üöÄ T√ºm d√ºzeltmeler ba≈ülatƒ±lƒ±yor...\n');
        
        try {
            await this.fixBarcodeUpdateError();
            await this.fixReturnFunctionality();
            await this.fixCustomerProductIssues();
            await this.fixNetworkConnectivity();
            await this.cleanupUnnecessaryCSS();
            await this.improveCategoryManagement();
            await this.fixDuplicateBarcodeAndRestoreBackups();
            await this.fixReturnAPIEndpoints();

            console.log('\n‚úÖ T√ºm d√ºzeltmeler ba≈üarƒ±yla tamamlandƒ±!\n');
            console.log('üìã D√ºzeltilen sorunlar:');
            this.fixes.forEach((fix, index) => {
                console.log(`   ${index + 1}. ${fix}`);
            });

            console.log('\nüîÑ Sunucuyu yeniden ba≈ülatmanƒ±z √∂nerilir.');
            console.log('üåê Yerel aƒü eri≈üimi i√ßin setup-network.bat √ßalƒ±≈ütƒ±rƒ±n.');
            
        } catch (error) {
            console.error('‚ùå D√ºzeltme i≈ülemi sƒ±rasƒ±nda hata:', error.message);
            throw error;
        } finally {
            this.db.close();
        }
    }
}

// D√ºzeltmeleri √ßalƒ±≈ütƒ±r
if (require.main === module) {
    const fixes = new TurkishInventorySystemFixes();
    fixes.runAllFixes().catch(console.error);
}

module.exports = TurkishInventorySystemFixes;